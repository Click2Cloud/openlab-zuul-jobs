- hosts: all
  become: yes
  roles:
    - ensure-legacy-workspace-directory
  tasks:

    - shell:
        cmd: |
          set -e
          set -x
          wget -c https://storage.googleapis.com/golang/go1.9.linux-amd64.tar.gz
          sudo tar -C /usr/local/ -xvzf go1.9.linux-amd64.tar.gz

          # Install env variables
          export GOPATH={{ ansible_user_dir }}
          mkdir -p $GOPATH/{bin,pkg}
          export PATH=$PATH:$GOPATH/bin:/usr/local/go/bin
          export GOBIN=$GOPATH/bin

          if [[ ! -d $GOPATH/src/github.com/gophercloud/gophercloud/ ]]; then
              echo "Warnning: this is a temporary workaround because this job is not triggered from official git repo."
              mkdir -p $GOPATH/src/github.com/gophercloud/
              cp -r $GOPATH/src/github.com/theopenlab/gophercloud  $GOPATH/src/github.com/gophercloud/
              cd $GOPATH/src/github.com/gophercloud/gophercloud
          fi

          TXT_LOG_FILE='{{ ansible_user_dir }}/workspace/test_results.txt'
          XML_LOG_FILE='{{ ansible_user_dir }}/workspace/test_results.xml'
          HTML_LOG_FILE='{{ ansible_user_dir }}/workspace/test_results.html'
          go get ./... || true
          ./script/unittest -v 2>&1 | tee $TXT_LOG_FILE

          go get -u github.com/jstemmer/go-junit-report
          go-junit-report < $TXT_LOG_FILE > $XML_LOG_FILE

          apt install npm -y
          npm install -g npm
          npm install -g n
          n stable
          ln -sf /usr/local/n/versions/node/9.2.0/bin/node /usr/bin/node
          npm install -g xunit-viewer
          xunit-viewer --results=$XML_LOG_FILE --output=$HTML_LOG_FILE --title='OpenLab'
        executable: /bin/bash
        chdir: '{{ zuul.project.src_dir }}'
      environment: '{{ zuul | zuul_legacy_vars }}'
